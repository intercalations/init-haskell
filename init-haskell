#! /usr/bin/env nix-shell
#! nix-shell --pure --keep NIX_SSL_CERT_FILE --keep GITHUB_TOKEN -i bash -p git mustache-go niv direnv nix
set -Eeuxo pipefail

# init-haskell location
base=$(dirname "$(readlink -f "$0")")

# Variables
data=$(mktemp)
cat <<EOF >$data
{ "author": "$(git config user.name)"
, "email": "$(git config user.email)"
, "ghc": "ghc883"
, "snapshot": "2020-02-04T00:00:00Z"
, "projectname": "pls"
}
EOF

# Set up git
git init
mustache $base/templates/.gitignore >.gitignore <$data

# Set up niv
mkdir nix
mustache $base/templates/sources.json >./nix/sources.json <$data
niv init

# Create hpack project
mustache $base/templates/cabal.project >./cabal.project <$data
mustache $base/templates/package.yaml >./package.yaml <$data

# Add default.nix
mustache $base/templates/default.nix >./default.nix <$data
mustache $base/templates/shell.nix >./shell.nix <$data

# Add hie.yaml file to help ghcide figure out what's what
mustache $base/templates/hie.yaml >./hie.yaml <$data

# Create direnv file
# TODO: Remove the grep stuff once https://github.com/hercules-ci/ghcide-nix/issues/26 is resolved
mustache $base/templates/.envrc >./.envrc <$data

# Add note about caching
mustache $base/templates/CACHES.md >./CACHES.md <$data

# Add a hello world source file
mkdir src
mustache $base/templates/Main.hs >./src/Main.hs <$data

git add .
